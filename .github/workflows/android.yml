on:
  push:
    branches: master
    tags: '*'

jobs:
  release_build:
     runs-on: ubuntu-latest
     if: startsWith(github.ref, 'refs/tags/')
 
     steps:
       - uses: actions/checkout@v2.6.0
 
       - name: Setup JAVA 17
         uses: actions/setup-java@v3
         with:
           distribution: 'corretto'
           java-version: 17
 
       - name: Cache Gradle and wrapper
         uses: actions/cache@v3
         with:
           path: |
             ~/.gradle/caches
             ~/.gradle/wrapper
           key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
      
      #1     
       - name: Decode Keystore
         env:
           # Encode using base64 app/keystore.jks  | tr -d '\012'; echo
           ENCODED_STRING: ${{ secrets.SIGNING_KEY_STORE_BASE64 }}
           SIGNING_KEY_STORE_PATH: keystore.jks
 
         run: |
           echo "$ENCODED_STRING" > keystore-b64.txt
           base64 -d keystore-b64.txt > app/$SIGNING_KEY_STORE_PATH
           
       #2
       - name: Build Release apk
         env:
           SIGNING_KEY_STORE_PATH: keystore.jks
           SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
           SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
           SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
         run: ./gradlew assembleRelease
 
       #3
       - name: Rename apk
         run: |
           mv -v app/build/outputs/apk/release/app-release.apk app/build/outputs/apk/release/`basename ${GITHUB_REPOSITORY}`_${GITHUB_REF_NAME}.apk
       #4
       - name: Upload Release Build to Artifacts
         uses: actions/upload-artifact@v4
         with:
           name: release-artifacts
           path: app/build/outputs/apk/release/
       #5
       - name: Create Github Release
         uses: softprops/action-gh-release@v1
         with:
           generate_release_notes: true
           files: |
             app/build/outputs/apk/release/*_*.apk
